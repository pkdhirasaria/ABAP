*&---------------------------------------------------------------------*
*& Report ZSAPN_INTERACTIVE_REPORT1
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT ZSAPN_INTERACTIVE_REPORT .

TYPES: BEGIN OF ITAB,
         CONNID    TYPE  SFLIGHT-CONNID,
         PLANETYPE TYPE SFLIGHT-PLANETYPE,
         PRICE     TYPE SFLIGHT-PRICE,
         CURRENCY  TYPE SFLIGHT-CURRENCY,
       END OF ITAB.

TYPES: BEGIN OF ITAB2,
         CONNID   TYPE  SFLIGHT-CONNID,
         FLDATE   TYPE SFLIGHT-FLDATE,
         CITYFROM TYPE SPFLI-CITYFROM,
         CITYTO   TYPE SPFLI-CITYTO,
       END OF ITAB2.

TYPES: BEGIN OF TABLE_SPFLI,
         CONNID   TYPE  SFLIGHT-CONNID,
         FLDATE   TYPE SFLIGHT-FLDATE,
         CITYFROM TYPE SPFLI-CITYFROM,
       END OF TABLE_SPFLI.

DATA : IT_SFLIGHT  TYPE STANDARD TABLE OF ITAB, "SFLIGHT internal table
       WA_SFLIGHT  TYPE ITAB, "SFLIGHT work area
       IT_SFLIGHT2 TYPE TABLE OF ITAB2,
       WA_SFLIGHT2 TYPE ITAB2,
       IT_SPFLI    TYPE TABLE OF TABLE_SPFLI,
       WA_SPFLI    TYPE TABLE_SPFLI.

PARAMETERS DATE LIKE WORKFLDS-GKDAY.

INITIALIZATION.
  DATE = SY-DATUM.

AT SELECTION-SCREEN.
  PERFORM VALIDATE_INPUT.

START-OF-SELECTION.
  PERFORM GET_FLIGHT_DATA. "sfight data into internal table it_sflight
  PERFORM DISPLAY_FLIGHT_DATA. "display data from internal table


AT LINE-SELECTION.
  IF sy-lsind EQ 1.
    PERFORM GET_SECONDARY_DATA. "get flight number details.
  ENDIF.
  IF sy-lsind EQ 2.
    PERFORM GET_CITY_DATA. "get flight details flying from city.
    PERFORM DISPLAY_CITY_DATA. "display flight details flying from city.
  ENDIF.

FORM VALIDATE_INPUT.
  IF DATE IS INITIAL.
    MESSAGE 'PLEASE ENTER VALID INPUT' TYPE 'E'.
  ENDIF.
ENDFORM.

FORM GET_FLIGHT_DATA.
  SELECT DISTINCT CONNID,PLANETYPE,PRICE,CURRENCY
    FROM SFLIGHT
    INTO TABLE @IT_SFLIGHT
    WHERE SFLIGHT~FLDATE EQ @DATE.
  SORT IT_SFLIGHT.
ENDFORM.


FORM DISPLAY_FLIGHT_DATA.
  DATA CUR TYPE ZEXCHANGE_VAL.
  DATA TOTAL TYPE ZEXCHANGE_VAL.

  WRITE :/ 'FLIGHT NUMBER' COLOR 1,
    20 'FLIGHT TYPE' COLOR 2,
    40 'COST' COLOR 3.
  NEW-LINE.
  LOOP AT IT_SFLIGHT INTO WA_SFLIGHT.
    TRY .
        CALL FUNCTION 'ZEXCHANGE_CONVERTER' "function call to convert local currency to INR
          EXPORTING
            CURRENCY_VALUE = WA_SFLIGHT-PRICE
            CURRENCY       = WA_SFLIGHT-CURRENCY
          IMPORTING
            FINAL_CURR     = CUR.
      CATCH CX_ROOT.
        WRITE : 'ERROR IN FUNCTION CALL'.
    ENDTRY.

    WRITE : / WA_SFLIGHT-CONNID,
      20 WA_SFLIGHT-PLANETYPE ,
      40 CUR,
       'INR'.
    TRY .
        TOTAL = TOTAL + CUR. "getting total of each INR currency
      CATCH CX_ROOT.
        WRITE: 'ERROR :( '.
        NEW-LINE.
    ENDTRY.

  ENDLOOP.
  NEW-LINE.
  ULINE.
  IF TOTAL GT 0.
    WRITE : 27 'TOTAL COST :' , TOTAL, 'INR'.
  ENDIF.
ENDFORM.


FORM GET_SECONDARY_DATA.
  DATA : FNAM TYPE C LENGTH 30, FVAL TYPE C LENGTH 30.
  GET CURSOR FIELD FNAM VALUE FVAL.
  IF FNAM ='WA_SFLIGHT-CONNID'.
    SELECT SF~CONNID,SF~FLDATE, CITYFROM,CITYTO INTO CORRESPONDING FIELDS OF TABLE @IT_SFLIGHT2
    FROM SFLIGHT AS SF INNER JOIN SPFLI AS SP ON SF~CONNID EQ SP~CONNID
    WHERE SF~CONNID EQ @FVAL.
    PERFORM DISPLAY_SECONDARY_DATA. "display flight number details.
  ENDIF.
ENDFORM.

FORM DISPLAY_SECONDARY_DATA.
  WRITE: / 'FLIGHT NUMBER' COLOR 1,
  19 'FLIGHT DATE' COLOR 2,
  35 'FROM' COLOR 3,
  49 'TO' COLOR 4.
  NEW-LINE.
  LOOP AT IT_SFLIGHT2 INTO WA_SFLIGHT2.
    WRITE : / WA_SFLIGHT2-CONNID,
    19 WA_SFLIGHT2-FLDATE,
    35 WA_SFLIGHT2-CITYFROM,
    49 WA_SFLIGHT2-CITYTO.
    HIDE WA_SFLIGHT2.
    NEW-LINE.
  ENDLOOP.
ENDFORM.


FORM GET_CITY_DATA.
  SELECT CITYFROM,SP~CONNID,FLDATE INTO CORRESPONDING FIELDS OF TABLE @IT_SPFLI
    FROM SPFLI AS SP INNER JOIN SFLIGHT AS SF ON SP~CONNID EQ SF~CONNID
    WHERE SP~CITYFROM EQ @WA_SFLIGHT2-CITYFROM.
ENDFORM.

FORM DISPLAY_CITY_DATA.
  WRITE: / 'CITY FROM' COLOR 1,
  15 'FLIGHT NUMBER' COLOR 2,
  30 'FLIGHT DATE' COLOR 3.
  NEW-LINE.
  LOOP AT IT_SPFLI INTO WA_SPFLI.
    WRITE: / WA_SPFLI-CITYFROM,
    15 WA_SPFLI-CONNID,
    30 WA_SPFLI-FLDATE.
  ENDLOOP.
ENDFORM.
